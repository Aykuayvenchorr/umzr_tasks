{% load static %}
{% load menu_tags %}
{% load app_task_tags_inclusions %}



{% if task.actual %}
<div class="card text-white bg-dark mt-3">
{% else %}
<div class="card text-white mt-3" style="background-color: #5a6268;">
{% endif %}
<h5 class="card-header font-weight-normal d-flex justify-content-between">
  <div class="d-flex align-items-center" style="gap: 15px;">
      <span class="font-weight-bold font-italic">
        #{{ task.id }} {{ task.name }}
      </span>
      <div class="mt-3">
        <form method="post" action="{% url 'task_change_parent' task.id %}">
          {% csrf_token %}
          <div class="input-group input-group-sm mt-2" style="max-width: 300px;">
            <input type="number" name="parent_id" class="form-control" placeholder="ID –≥–æ–ª–æ–≤–Ω–æ–π –∑–∞–¥–∞—á–∏ ‚Äî {% if task.parent %}{{ task.parent.id }}{% else %}{% endif %}">
            <button class="btn btn-outline-light" type="submit">–°–º–µ–Ω–∏—Ç—å</button>
          </div>
        </form>
      </div>
  </div>

  <div class="d-flex ms-auto gap-2">
      {% if task.status %}
      <span>
          {% if task.status == 'not' %}
              <span class="badge bg-primary">–ù–µ –Ω–∞—á–∞—Ç–∞</span>
          {% elif task.status == 'worked' %}
              <span class="badge bg-warning text-dark">–í —Ä–∞–±–æ—Ç–µ</span>
          {% elif task.status == 'ended' %}
              <span class="badge bg-success">–ó–∞–≤–µ—Ä—à–µ–Ω–∞</span>
          {% elif task.status == 'canceled' %}
              <span class="badge bg-secondary">–û—Ç–º–µ–Ω–µ–Ω–∞</span>
          {% else %}
              <span class="badge bg-light text-dark">{{ task.get_status_display }}</span>
          {% endif %}
      </span>
      {% endif %}
  
      {% if task.importance %}
      <span>
          {% if task.importance == 'high' %}
              <span class="badge bg-danger">–í—ã—Å–æ–∫–∞—è –≤–∞–∂–Ω–æ—Å—Ç—å</span>
          {% elif task.importance == 'medium' %}
              <span class="badge bg-warning text-dark">–°—Ä–µ–¥–Ω—è—è –≤–∞–∂–Ω–æ—Å—Ç—å</span>
          {% elif task.importance == 'low' %}
              <span class="badge bg-success">–ù–∏–∑–∫–∞—è –≤–∞–∂–Ω–æ—Å—Ç—å</span>
          {% else %}
              <span class="badge bg-light text-dark">{{ task.get_importance_display }}</span>
          {% endif %}
      </span>
      {% endif %}
  </div>
</h5>
<!-- –ö–Ω–æ–ø–∫–∞ –¥–ª—è —Ä–µ–¥–∏—Ä–µ–∫—Ç–∞ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ–¥–∑–∞–¥–∞—á–∏ -->
<div class="card-body">
  <a href="{% url 'task_add' type=type id=type_id tid=task.id %}" class="btn btn-info">
    –î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥–∑–∞–¥–∞—á—É
</a>
</div>

    <div class="card-body">
      <blockquote class="blockquote mt-0">
        <p>{{ task.desc|safe }}</p>

        

        <footer class="blockquote-footer mt-3">
          <cite title="–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π" style="color: #dee2e6; font-size: 0.95rem;">
            –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π: {{ task.user_responsible.surname }} {{ task.user_responsible.name }}
          </cite>
        </footer>
      </blockquote>

      {# –ê–∫–∫–æ—Ä–¥–µ–æ–Ω –¥–ª—è —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏—Ö/–ø–ª–∞–Ω–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö #}
      <div class="accordion mt-3" id="accordionTask{{ task.id }}">
        <div class="accordion-item bg-dark text-white">
          <h2 class="accordion-header" id="heading{{ task.id }}">
            <button class="accordion-button collapsed bg-dark text-white" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ task.id }}" aria-expanded="false" aria-controls="collapse{{ task.id }}">
              –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –æ–ø–ª–∞—Ç–µ
            </button>
          </h2>
          <div id="collapse{{ task.id }}" class="accordion-collapse collapse" aria-labelledby="heading{{ task.id }}" data-bs-parent="#accordionTask{{ task.id }}">
            <div class="accordion-body">

              {% if task.fact_fin_dt %}
              <p><strong>–§–∞–∫—Ç–∏—á–µ—Å–∫–∞—è –¥–∞—Ç–∞ —Ñ–∏–Ω–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–∏—è:</strong> {{ task.fact_fin_dt|date:"Y-m-d" }}</p>
              {% endif %}
              
              {% if task.fact_fin_cost %}
              <p><strong>–§–∞–∫—Ç–∏—á–µ—Å–∫–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å —Ñ–∏–Ω–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–∏—è:</strong> {{ task.fact_fin_cost }}</p>
              {% endif %}

              {% if task.fact_dev_dt %}
              <p><strong>–§–∞–∫—Ç–∏—á–µ—Å–∫–∞—è –¥–∞—Ç–∞ –æ—Å–≤–æ–µ–Ω–∏—è:</strong> {{ task.fact_dev_dt|date:"Y-m-d" }}</p>
              {% endif %}

              {% if task.fact_dev_cost %}
              <p><strong>–§–∞–∫—Ç–∏—á–µ—Å–∫–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –æ—Å–≤–æ–µ–Ω–∏—è:</strong> {{ task.fact_dev_cost }}</p>
              {% endif %}

              {% if task.cost_info %}
              <p><strong>–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ –∫ –æ–ø–ª–∞—Ç–µ:</strong> {{ task.cost_info|safe }}</p>
              {% endif %}

              {% if task.plancost.first %}
              <hr>
              <p><strong>–ü–ª–∞–Ω–æ–≤–∞—è –¥–∞—Ç–∞ —Ñ–∏–Ω–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–∏—è:</strong> {{ task.plancost.first.plan_fin_dt|date:"Y-m-d" }}</p>
              <p><strong>–ü–ª–∞–Ω–æ–≤–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å —Ñ–∏–Ω–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–∏—è:</strong> {{ task.plancost.first.plan_fin_cost }}</p>
              <p><strong>–ü–ª–∞–Ω–æ–≤–∞—è –¥–∞—Ç–∞ –æ—Å–≤–æ–µ–Ω–∏—è:</strong> {{ task.plancost.first.plan_dev_dt|date:"Y-m-d" }}</p>
              <p><strong>–ü–ª–∞–Ω–æ–≤–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –æ—Å–≤–æ–µ–Ω–∏—è:</strong> {{ task.plancost.first.plan_dev_cost }}</p>
              <p><strong>–ù–î–° (%):</strong> {{ task.plancost.first.nds }}</p>
              <p><strong>–ù–î–§–õ (%):</strong> {{ task.plancost.first.ndfl }}</p>
              {% endif %}

            </div>
          </div>
        </div>
      </div>

      {# –ü—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã #}
      {% if task.documents.all %}
      <h6 class="mt-3 text-secondary small">üìé –ü—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:</h6>
      <div class="d-flex flex-column">
        {% for doc in task.documents.all %}
          <div class="card text-white border-0 mb-1 p-2" style="max-width: 200px; font-size: 0.85rem; background-color: #4e555b;">
              <a href="{{ doc.file.url }}" target="_blank" 
                 class="text-white text-decoration-none d-flex align-items-center"
                 style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block; max-width: 180px;">
                  <i class="bi bi-file-earmark-text me-2"></i> 
                  {{ doc.title|default:doc.file.name }}
              </a>
          </div>
        {% endfor %}
      </div>
      {% endif %}
      {# –ü–ª–∞–Ω–æ–≤—ã–µ –¥–∞—Ç—ã –Ω–∞—á–∞–ª–∞ –∏ –æ–∫–æ–Ω—á–∞–Ω–∏—è #}
      {% if task.plandatestart.first %}
        <p class="mt-3"><strong>–ü–ª–∞–Ω–æ–≤–∞—è –¥–∞—Ç–∞ –Ω–∞—á–∞–ª–∞:</strong> {{ task.plandatestart.first.dt_start|date:"Y-m-d" }}</p>
      {% endif %}
      {% if task.plandateend.first %}
        <p><strong>–ü–ª–∞–Ω–æ–≤–∞—è –¥–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è:</strong> {{ task.plandateend.first.dt_end|date:"Y-m-d" }}</p>
      {% endif %}  
    </div>

    {% if task.task_set.exists %}
    <div class="mt-3">
        <button class="btn btn-outline-light btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#subtasks{{ task.id }}" aria-expanded="false" aria-controls="subtasks{{ task.id }}">
            –ü–æ–¥–∑–∞–¥–∞—á–∏ <span style="font-size: 1.2rem;">‚ñº</span>
        </button>
        <div class="collapse mt-3 ms-3" id="subtasks{{ task.id }}">
          <ul class="list-group" style="padding-left: 1rem;">
            {% for subtask in task.task_set.all %}
                <li class="list-group-item bg-dark text-white p-2">
                    {% block_task subtask.id type type_id %}
                </li>
            {% empty %}
                <li class="list-group-item bg-dark text-white">–ü–æ–¥–∑–∞–¥–∞—á –ø–æ–∫–∞ –Ω–µ—Ç</li>
            {% endfor %}
          </ul>
        </div>
    </div>
    {% endif %}

</div>