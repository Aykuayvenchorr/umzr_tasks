from django import template
from django.utils.html import format_html
from django.db.models import Q

from app_struct.models import *
from app_struct.forms import *


register = template.Library()


@register.simple_tag
def img_company():
    return format_html('<svg class="svg-btn" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 480 480"><path class="svg-btn" d="m232 288h16v16h-16zm0 0"/><path d="m472 416h-48v-24c0-4.417969-3.582031-8-8-8h-168v-24h24c4.417969 0 8-3.582031 8-8v-32h8c13.253906 0 24-10.746094 24-24v-16c-.03125-23.671875-17.3125-43.789062-40.710938-47.382812 5.601563-6.988282 8.671876-15.664063 8.710938-24.617188 0-22.089844-17.910156-40-40-40s-40 17.910156-40 40c.039062 8.953125 3.109375 17.628906 8.710938 24.617188-23.398438 3.59375-40.679688 23.710937-40.710938 47.382812v16c0 13.253906 10.746094 24 24 24h8v32c0 4.417969 3.582031 8 8 8h24v24h-168c-4.417969 0-8 3.582031-8 8v24h-48c-4.417969 0-8 3.582031-8 8v48c0 4.417969 3.582031 8 8 8h112c4.417969 0 8-3.582031 8-8v-48c0-4.417969-3.582031-8-8-8h-48v-16h160v16h-48c-4.417969 0-8 3.582031-8 8v48c0 4.417969 3.582031 8 8 8h112c4.417969 0 8-3.582031 8-8v-48c0-4.417969-3.582031-8-8-8h-48v-16h160v16h-48c-4.417969 0-8 3.582031-8 8v48c0 4.417969 3.582031 8 8 8h112c4.417969 0 8-3.582031 8-8v-48c0-4.417969-3.582031-8-8-8zm-232-232c13.253906 0 24 10.746094 24 24s-10.746094 24-24 24-24-10.746094-24-24 10.746094-24 24-24zm-24 128v-32h-16v24h-8c-4.417969 0-8-3.582031-8-8v-16c0-17.671875 14.328125-32 32-32h16v24h16v-24h16c17.671875 0 32 14.328125 32 32v16c0 4.417969-3.582031 8-8 8h-8v-24h-16v64h-48zm-104 152h-96v-32h96zm176 0h-96v-32h96zm176 0h-96v-32h96zm0 0"/><path d="m56 168h16v16h-16zm0 0"/><path d="m88 168h16v16h-16zm0 0"/><path d="m56 200h16v16h-16zm0 0"/><path d="m88 200h16v16h-16zm0 0"/><path d="m168 72h16v16h-16zm0 0"/><path d="m200 72h16v16h-16zm0 0"/><path d="m168 104h16v16h-16zm0 0"/><path d="m200 104h16v16h-16zm0 0"/><path d="m168 144h16v16h-16zm0 0"/><path d="m200 144h16v16h-16zm0 0"/><path d="m168 176h16v16h-16zm0 0"/><path d="m296 144h16v16h-16zm0 0"/><path d="m264 144h16v16h-16zm0 0"/><path d="m296 176h16v16h-16zm0 0"/><path d="m296 72h16v16h-16zm0 0"/><path d="m264 72h16v16h-16zm0 0"/><path d="m296 104h16v16h-16zm0 0"/><path d="m264 104h16v16h-16zm0 0"/><path d="m56 240h16v16h-16zm0 0"/><path d="m88 240h16v16h-16zm0 0"/><path d="m56 272h16v16h-16zm0 0"/><path d="m88 272h16v16h-16zm0 0"/><path d="m408 168h16v16h-16zm0 0"/><path d="m376 168h16v16h-16zm0 0"/><path d="m408 200h16v16h-16zm0 0"/><path d="m376 200h16v16h-16zm0 0"/><path d="m408 240h16v16h-16zm0 0"/><path d="m376 240h16v16h-16zm0 0"/><path d="m408 272h16v16h-16zm0 0"/><path d="m376 272h16v16h-16zm0 0"/><path d="m472 96h-120v-48h8c4.417969 0 8-3.582031 8-8v-32c0-4.417969-3.582031-8-8-8h-240c-4.417969 0-8 3.582031-8 8v32c0 4.417969 3.582031 8 8 8h8v48h-120c-4.417969 0-8 3.582031-8 8v32c0 4.417969 3.582031 8 8 8h8v256h16v-64h96v32h16v-320h192v320h16v-32h96v64h16v-256h8c4.417969 0 8-3.582031 8-8v-32c0-4.417969-3.582031-8-8-8zm-456 16h112v16h-112zm16 208v-176h96v176zm104-288h-8v-16h224v16zm216 288v-176h96v176zm112-192h-112v-16h112zm0 0"/></svg>')

@register.simple_tag
def get_companies():
    return Company.objects.filter(actual=True).order_by('title')

@register.simple_tag
def get_divisions(company_id):
    return Company.objects.get(id=company_id).divisions.filter(Q(actual=True) & Q(parent__isnull=True)).order_by('abbr')

@register.simple_tag
def get_subdivisions(division_id):
    return Division.objects.get(id=division_id).subdivisions.filter(actual=True).order_by('abbr')

@register.simple_tag
def get_licenses(company_id):
    return Company.objects.get(id=company_id).licenses.filter(actual=True).order_by('name')

@register.simple_tag
def get_facilities(license_id):
    return License.objects.get(id=license_id).facilities.filter(Q(actual=True) & Q(parent__isnull=True)).order_by('name')

@register.simple_tag
def get_subfacilities(facility_id):
    return Facility.objects.get(id=facility_id).facilities.filter(actual=True).order_by('name')


@register.inclusion_tag('includes/menu_tag.html', takes_context=True)
def menu_tag(context): 
    companies_main = Company.main.all()
    context = {
        'user':             context['user'],
        'companies_main':   companies_main,
        'svg_divisions': format_html('<svg class="svg-btn" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 480 480"><path class="svg-btn" d="m264 384h-48c-22.082031.027344-39.972656 17.917969-40 40v48c0 4.417969 3.582031 8 8 8h112c4.417969 0 8-3.582031 8-8v-48c-.027344-22.082031-17.917969-39.972656-40-40zm24 80h-96v-40c0-13.253906 10.746094-24 24-24h48c13.253906 0 24 10.746094 24 24zm0 0"/><path d="m440 384h-48c-22.082031.027344-39.972656 17.917969-40 40v48c0 4.417969 3.582031 8 8 8h112c4.417969 0 8-3.582031 8-8v-48c-.027344-22.082031-17.917969-39.972656-40-40zm24 80h-96v-40c0-13.253906 10.746094-24 24-24h48c13.253906 0 24 10.746094 24 24zm0 0"/><path d="m88 384h-48c-22.082031.027344-39.9726562 17.917969-40 40v48c0 4.417969 3.582031 8 8 8h112c4.417969 0 8-3.582031 8-8v-48c-.027344-22.082031-17.917969-39.972656-40-40zm24 80h-96v-40c0-13.253906 10.746094-24 24-24h48c13.253906 0 24 10.746094 24 24zm0 0"/><path d="m64 376c20.550781.019531 37.773438-15.535156 39.835938-35.980469 2.066406-20.445312-11.695313-39.128906-31.835938-43.21875v-32.800781h160v32.800781c-20.121094 4.105469-33.863281 22.78125-31.796875 43.210938 2.0625 20.429687 19.261719 35.980469 39.796875 35.980469s37.734375-15.550782 39.796875-35.980469c2.066406-20.429688-11.675781-39.105469-31.796875-43.210938v-32.800781h160v32.800781c-20.121094 4.105469-33.863281 22.78125-31.796875 43.210938 2.0625 20.429687 19.261719 35.980469 39.796875 35.980469s37.734375-15.550782 39.796875-35.980469c2.066406-20.429688-11.675781-39.105469-31.796875-43.210938v-40.800781c0-4.417969-3.582031-8-8-8h-352c-4.417969 0-8 3.582031-8 8v40.800781c-20.140625 4.089844-33.902344 22.773438-31.835938 43.21875 2.0625 20.445313 19.285157 36 39.835938 35.980469zm200-40c0 13.253906-10.746094 24-24 24s-24-10.746094-24-24 10.746094-24 24-24 24 10.746094 24 24zm176 0c0 13.253906-10.746094 24-24 24s-24-10.746094-24-24 10.746094-24 24-24 24 10.746094 24 24zm-376-24c13.253906 0 24 10.746094 24 24s-10.746094 24-24 24-24-10.746094-24-24 10.746094-24 24-24zm0 0"/><path d="m200 216h80c13.253906 0 24-10.746094 24-24v-64c-.027344-22.082031-17.917969-39.972656-40-40h-48c-22.082031.027344-39.972656 17.917969-40 40v64c0 13.253906 10.746094 24 24 24zm-8-24v-24h8v32c-4.417969 0-8-3.582031-8-8zm88 8v-32h8v24c0 4.417969-3.582031 8-8 8zm-32.855469-42.457031-7.144531 7.144531-7.144531-7.144531 5.390625-21.542969h3.507812zm-1.390625-53.542969-4 16h-3.507812l-4-16zm-29.753906 0h1.761719l6 24-7.523438 30.054688c-.679687 2.726562.117188 5.613281 2.105469 7.601562l16 16c3.125 3.121094 8.1875 3.121094 11.3125 0l16-16c1.988281-1.988281 2.785156-4.875 2.105469-7.601562l-7.523438-30.054688 6-24h1.761719c13.253906 0 24 10.746094 24 24v24h-16c-4.417969 0-8 3.582031-8 8v40h-48v-40c0-4.417969-3.582031-8-8-8h-16v-24c0-13.253906 10.746094-24 24-24zm0 0"/><path d="m208 33.761719v22.238281c0 13.253906 10.746094 24 24 24h16c13.253906 0 24-10.746094 24-24v-16c4.417969 0 8-3.582031 8-8v-8c0-13.253906-10.746094-24-24-24h-48c-4.417969 0-8 3.582031-8 8v8c.019531 6.789062 2.929688 13.246094 8 17.761719zm48 22.238281c0 4.417969-3.582031 8-8 8h-16c-4.417969 0-8-3.582031-8-8v-16h32zm0-40c4.417969 0 8 3.582031 8 8h-40c-4.417969 0-8-3.582031-8-8zm0 0"/></svg>'),
        'svg_companies': format_html('<svg class="svg-btn" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 480 480"><path class="svg-btn" d="m232 288h16v16h-16zm0 0"/><path d="m472 416h-48v-24c0-4.417969-3.582031-8-8-8h-168v-24h24c4.417969 0 8-3.582031 8-8v-32h8c13.253906 0 24-10.746094 24-24v-16c-.03125-23.671875-17.3125-43.789062-40.710938-47.382812 5.601563-6.988282 8.671876-15.664063 8.710938-24.617188 0-22.089844-17.910156-40-40-40s-40 17.910156-40 40c.039062 8.953125 3.109375 17.628906 8.710938 24.617188-23.398438 3.59375-40.679688 23.710937-40.710938 47.382812v16c0 13.253906 10.746094 24 24 24h8v32c0 4.417969 3.582031 8 8 8h24v24h-168c-4.417969 0-8 3.582031-8 8v24h-48c-4.417969 0-8 3.582031-8 8v48c0 4.417969 3.582031 8 8 8h112c4.417969 0 8-3.582031 8-8v-48c0-4.417969-3.582031-8-8-8h-48v-16h160v16h-48c-4.417969 0-8 3.582031-8 8v48c0 4.417969 3.582031 8 8 8h112c4.417969 0 8-3.582031 8-8v-48c0-4.417969-3.582031-8-8-8h-48v-16h160v16h-48c-4.417969 0-8 3.582031-8 8v48c0 4.417969 3.582031 8 8 8h112c4.417969 0 8-3.582031 8-8v-48c0-4.417969-3.582031-8-8-8zm-232-232c13.253906 0 24 10.746094 24 24s-10.746094 24-24 24-24-10.746094-24-24 10.746094-24 24-24zm-24 128v-32h-16v24h-8c-4.417969 0-8-3.582031-8-8v-16c0-17.671875 14.328125-32 32-32h16v24h16v-24h16c17.671875 0 32 14.328125 32 32v16c0 4.417969-3.582031 8-8 8h-8v-24h-16v64h-48zm-104 152h-96v-32h96zm176 0h-96v-32h96zm176 0h-96v-32h96zm0 0"/><path d="m56 168h16v16h-16zm0 0"/><path d="m88 168h16v16h-16zm0 0"/><path d="m56 200h16v16h-16zm0 0"/><path d="m88 200h16v16h-16zm0 0"/><path d="m168 72h16v16h-16zm0 0"/><path d="m200 72h16v16h-16zm0 0"/><path d="m168 104h16v16h-16zm0 0"/><path d="m200 104h16v16h-16zm0 0"/><path d="m168 144h16v16h-16zm0 0"/><path d="m200 144h16v16h-16zm0 0"/><path d="m168 176h16v16h-16zm0 0"/><path d="m296 144h16v16h-16zm0 0"/><path d="m264 144h16v16h-16zm0 0"/><path d="m296 176h16v16h-16zm0 0"/><path d="m296 72h16v16h-16zm0 0"/><path d="m264 72h16v16h-16zm0 0"/><path d="m296 104h16v16h-16zm0 0"/><path d="m264 104h16v16h-16zm0 0"/><path d="m56 240h16v16h-16zm0 0"/><path d="m88 240h16v16h-16zm0 0"/><path d="m56 272h16v16h-16zm0 0"/><path d="m88 272h16v16h-16zm0 0"/><path d="m408 168h16v16h-16zm0 0"/><path d="m376 168h16v16h-16zm0 0"/><path d="m408 200h16v16h-16zm0 0"/><path d="m376 200h16v16h-16zm0 0"/><path d="m408 240h16v16h-16zm0 0"/><path d="m376 240h16v16h-16zm0 0"/><path d="m408 272h16v16h-16zm0 0"/><path d="m376 272h16v16h-16zm0 0"/><path d="m472 96h-120v-48h8c4.417969 0 8-3.582031 8-8v-32c0-4.417969-3.582031-8-8-8h-240c-4.417969 0-8 3.582031-8 8v32c0 4.417969 3.582031 8 8 8h8v48h-120c-4.417969 0-8 3.582031-8 8v32c0 4.417969 3.582031 8 8 8h8v256h16v-64h96v32h16v-320h192v320h16v-32h96v64h16v-256h8c4.417969 0 8-3.582031 8-8v-32c0-4.417969-3.582031-8-8-8zm-456 16h112v16h-112zm16 208v-176h96v176zm104-288h-8v-16h224v16zm216 288v-176h96v176zm112-192h-112v-16h112zm0 0"/></svg>'),
    }
    return context

@register.inclusion_tag('includes/card_division_tag.html', takes_context=True)
def card_division_tag(context, id_comp, id_div): 
    company = Company.objects.get(id=id_comp)
    division = Division.objects.get(id=id_div)
    context = {
        'user':             context['user'],
        'company':          company,
        'division':         division,
    }
    return context

@register.inclusion_tag('includes/card_facility_tag.html', takes_context=True)
def card_facility_tag(context, id_comp, id_lic, id_fc): 
    company = Company.objects.get(id=id_comp)
    license = License.objects.get(id=id_lic)
    facility = Facility.objects.get(id=id_fc)
    context = {
        'user':             context['user'],
        'company':          company,
        'license':          license,
        'facility':         facility,
    }
    return context
